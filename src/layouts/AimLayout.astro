---
// src/layouts/AimLayout.astro
import BaseLayout from './BaseLayout.astro';
import AimNavigation from '../components/AimNavigation.astro';

// The aimNumber is passed from the frontmatter of the .md file
const { frontmatter } = Astro.props;
const { aimNumber, tags = [] } = frontmatter;

// Determine course from URL path
const url = new URL(Astro.request.url);
const isHtmlCourse = url.pathname.includes('/html-aims/');
const courseName = isHtmlCourse ? 'Web Development: HTML' : 'Python Programming';
const courseIcon = isHtmlCourse ? '' : '';
const coursePath = isHtmlCourse ? '/html-aims' : '/aims';
const totalAims = isHtmlCourse ? 50 : 100;
const courseColor = isHtmlCourse ? 'var(--course-html-primary)' : 'var(--course-python-primary)';

// Calculate difficulty
let difficulty = 'Beginner';
if (aimNumber > 50) difficulty = 'Advanced';
else if (aimNumber > 25) difficulty = 'Intermediate';

// Calculate related aims (next/previous)
const previousAim = aimNumber > 0 ? aimNumber - 1 : null;
const nextAim = aimNumber < (totalAims - 1) ? aimNumber + 1 : null;
const estimatedTime = `${5 + (aimNumber % 20)} min`;
const progressPercent = Math.round((aimNumber / totalAims) * 100);
---
<BaseLayout>
    <div style={{maxWidth: '1280px', margin: '0 auto', padding: '0 16px'}} class="w-full">
        <!-- Breadcrumb -->
        <div style={{marginBottom: '24px', fontSize: '14px'}} aria-label="Breadcrumb">
            <a href="/" style={{color: 'var(--primary-blue)', textDecoration: 'none'}}>Home</a>
            <span style={{margin: '0 8px', color: 'var(--border-color)'}}>/</span>
            <a href="/collections" style={{color: 'var(--primary-blue)', textDecoration: 'none'}}>Collections</a>
            <span style={{margin: '0 8px', color: 'var(--border-color)'}}>/</span>
            <a href={coursePath} style={{color: courseColor, textDecoration: 'none'}}>{courseIcon} {courseName}</a>
            <span style={{margin: '0 8px', color: 'var(--border-color)'}}>/</span>
            <span style={{color: 'var(--text-secondary)'}}>Aim #{aimNumber.toString().padStart(2, '0')}</span>
        </div>

        <!-- Back Button -->
        <div style={{marginBottom: '32px'}}>
            <a href={coursePath} style={{display: 'inline-flex', alignItems: 'center', color: courseColor, textDecoration: 'none', fontSize: '14px', fontWeight: '500', transition: 'opacity 0.2s ease'}}>
                <svg style={{width: '20px', height: '20px', marginRight: '8px'}} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                Back to {courseName}
            </a>
        </div>

        <!-- Main Content Area with Sidebar -->
        <div class="aim-page-container">
            <!-- Main Content -->
            <main class="aim-content">
                <h1 style={{fontSize: '32px', fontWeight: 'bold', color: 'var(--text-primary)', marginBottom: '8px'}}>{frontmatter.title}</h1>
                <div style={{display: 'flex', flexWrap: 'wrap', gap: '16px', marginBottom: '32px', paddingBottom: '32px', borderBottom: '1px solid var(--border-color)', alignItems: 'center'}}>
                    <span class={`difficulty-badge difficulty-${difficulty.toLowerCase()}`} style={{fontSize: '12px', padding: '4px 12px', whiteSpace: 'nowrap'}}>{difficulty}</span>
                    <span style={{color: 'var(--text-secondary)', display: 'flex', alignItems: 'center', gap: '4px', fontSize: '13px', whiteSpace: 'nowrap'}}>
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style={{width: '16px', height: '16px', flexShrink: 0}}>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        {estimatedTime}
                    </span>
                </div>
                <slot />
            </main>

            <!-- Sidebar -->
            <aside class="aim-sidebar">
                <!-- Course Context -->
                <div class="sidebar-section" style={{borderColor: courseColor, borderLeft: `4px solid ${courseColor}`}}>
                    <h4 style={{color: courseColor}}>{courseIcon} {courseName}</h4>
                    <div class="aim-info-item">
                        <span class="info-label">Progress</span>
                        <div style={{width: '100%', height: '8px', backgroundColor: 'var(--border-color)', borderRadius: '4px', overflow: 'hidden'}}>
                            <div style={{width: `${progressPercent}%`, height: '100%', backgroundColor: courseColor, transition: 'width 0.3s ease'}}></div>
                        </div>
                        <span style={{fontSize: '11px', color: 'var(--text-primary)', whiteSpace: 'nowrap'}}>{aimNumber + 1} of {totalAims}</span>
                    </div>
                </div>

                <!-- Challenge Info -->
                <div class="sidebar-section">
                    <h4>Challenge Info</h4>
                    <div class="aim-info-item">
                        <span class="info-label">Aim #</span>
                        <span class="info-value">{aimNumber.toString().padStart(2, '0')}</span>
                    </div>
                    <div class="aim-info-item">
                        <span class="info-label">Difficulty</span>
                        <span class={`info-value difficulty-badge difficulty-${difficulty.toLowerCase()}`}>{difficulty}</span>
                    </div>
                    <div class="aim-info-item">
                        <span class="info-label">Est. Time</span>
                        <span class="info-value">{estimatedTime}</span>
                    </div>
                    <div class="aim-info-item">
                        <span class="info-label">Topics</span>
                        <span class="info-value">{tags.length}</span>
                    </div>
                </div>

                <!-- Mark as Complete Button -->
                <button class="complete-btn" id="complete-btn" style={{backgroundColor: courseColor}} aria-label="Mark this challenge as complete">
                    Mark Complete
                </button>

                <!-- Topics -->
                {tags.length > 0 && (
                    <div class="sidebar-section">
                        <h4>Topics Covered</h4>
                        <div class="space-y-2">
                            {tags.map((tag: string) => (
                                <div class="related-aim">
                                    <a href={`/aims?tag=${tag.toLowerCase()}`}>
                                        {tag}
                                    </a>
                                </div>
                            ))}
                        </div>
                    </div>
                )}

                <!-- Navigation -->
                <div class="sidebar-section">
                    <h4>Navigation</h4>
                    <div class="space-y-2">
                        {previousAim !== null && (
                            <div class="related-aim">
                                <a href={`${coursePath}/${previousAim}`} title="Previous challenge">
                                    Aim #{previousAim.toString().padStart(2, '0')}
                                </a>
                            </div>
                        )}
                        {nextAim !== null && (
                            <div class="related-aim">
                                <a href={`${coursePath}/${nextAim}`} title="Next challenge">
                                    Aim #{nextAim.toString().padStart(2, '0')}
                                </a>
                            </div>
                        )}
                        <div class="related-aim">
                            <a href={coursePath} title="View all challenges">
                                View All {courseName}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="sidebar-section">
                    <h4>Actions</h4>
                    <button style={{width: '100%', padding: '8px 16px', backgroundColor: 'var(--bg-secondary)', borderRadius: '6px', textAlign: 'center', fontSize: '14px', fontWeight: '500', border: 'none', cursor: 'pointer', transition: 'background-color 0.2s ease'}} id="share-btn" aria-label="Share this challenge">
                        Share
                    </button>
                </div>
            </aside>
        </div>

        <!-- Full Width Navigation -->
        <div style={{marginTop: '64px', paddingTop: '32px', borderTop: '1px solid var(--border-color)'}}>
            <AimNavigation aimNumber={aimNumber} coursePath={coursePath} totalAims={totalAims} />
        </div>
    </div>

    <script is:inline>
        document.addEventListener('DOMContentLoaded', () => {
            // Code block copy functionality - enhanced to handle Astro markdown rendering
            const codeBlocks = document.querySelectorAll('pre');

            codeBlocks.forEach(pre => {
                // Get the code element inside pre
                const code = pre.querySelector('code');
                if (!code) return;

                const container = document.createElement('div');
                container.classList.add('code-block-container');
                pre.parentNode.insertBefore(container, pre);
                container.appendChild(pre);

                const copyButton = document.createElement('button');
                copyButton.classList.add('copy-button');
                copyButton.textContent = 'Copy';
                copyButton.setAttribute('aria-label', 'Copy code to clipboard');
                copyButton.setAttribute('type', 'button');
                container.appendChild(copyButton);

                copyButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    const codeToCopy = code.textContent || code.innerText;
                    if (!codeToCopy) {
                        console.error('No code content found');
                        return;
                    }
                    
                    navigator.clipboard.writeText(codeToCopy).then(() => {
                        copyButton.textContent = 'Copied!';
                        setTimeout(() => {
                            copyButton.textContent = 'Copy';
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        copyButton.textContent = 'Copy Failed';
                        setTimeout(() => {
                            copyButton.textContent = 'Copy';
                        }, 2000);
                    });
                });
            });

            // Complete button functionality
            const completeBtn = document.getElementById('complete-btn');
            const aimNumber = window.location.pathname.split('/').pop();
            const completedChallenges = new Set(JSON.parse(localStorage.getItem('completed') || '[]'));

            if (completeBtn) {
                if (completedChallenges.has(aimNumber)) {
                    completeBtn.classList.add('completed');
                    completeBtn.textContent = 'Completed';
                }

                completeBtn.addEventListener('click', () => {
                    if (completedChallenges.has(aimNumber)) {
                        completedChallenges.delete(aimNumber);
                        completeBtn.classList.remove('completed');
                        completeBtn.textContent = 'Mark Complete';
                    } else {
                        completedChallenges.add(aimNumber);
                        completeBtn.classList.add('completed');
                        completeBtn.textContent = 'Completed';
                    }
                    localStorage.setItem('completed', JSON.stringify(Array.from(completedChallenges)));
                });
            }

            // Share button functionality
            const shareBtn = document.getElementById('share-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', () => {
                    const currentUrl = window.location.href;
                    const title = document.querySelector('h1')?.textContent || 'Check out this challenge';
                    
                    if (navigator.share) {
                        navigator.share({
                            title: 'CodeQuests Challenge',
                            text: title,
                            url: currentUrl
                        }).catch(err => console.log('Share failed:', err));
                    } else {
                        navigator.clipboard.writeText(currentUrl);
                        shareBtn.textContent = 'Link Copied';
                        setTimeout(() => {
                            shareBtn.textContent = 'Share';
                        }, 2000);
                    }
                });
            }
        });
    </script>
</BaseLayout>